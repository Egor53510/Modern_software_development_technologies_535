{% extends "base.html" %}

{% block title %}SQL Конструктор{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h3 class="mb-0"><i class="fas fa-code me-2"></i>SQL Конструктор запросов</h3>
            </div>
            <div class="card-body">
                <form id="sqlBuilderForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Тип запроса</label>
                                <select class="form-select" id="queryType">
                                    <option value="SELECT">SELECT</option>
                                    <option value="INSERT">INSERT</option>
                                    <option value="UPDATE">UPDATE</option>
                                    <option value="DELETE">DELETE</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Таблица</label>
                                <select class="form-select" id="tableSelect">
                                    <option value="">Выберите таблицу</option>
                                    {% for table in tables %}
                                    <option value="{{ table }}">{{ table }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- SELECT поля -->
                    <div id="selectFields" class="query-fields">
                        <div class="mb-3">
                            <label class="form-label">Поля для выбора</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="selectColumns" placeholder="* или field1, field2, field3">
                                <button class="btn btn-outline-secondary" type="button" id="getColumnsBtn">
                                    <i class="fas fa-list"></i> Получить поля
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">WHERE условие</label>
                            <textarea class="form-control" id="whereCondition" rows="3" placeholder="id > 10 AND name LIKE '%test%'"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ORDER BY</label>
                            <input type="text" class="form-control" id="orderBy" placeholder="id DESC, name ASC">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">LIMIT</label>
                            <input type="number" class="form-control" id="limit" placeholder="100">
                        </div>
                    </div>

                    <!-- INSERT поля -->
                    <div id="insertFields" class="query-fields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Значения для вставки (JSON)</label>
                            <textarea class="form-control" id="insertValues" rows="5" placeholder='{"name": "John", "age": 30}'></textarea>
                        </div>
                    </div>

                    <!-- UPDATE поля -->
                    <div id="updateFields" class="query-fields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">SET выражения</label>
                            <textarea class="form-control" id="setExpressions" rows="3" placeholder="name = 'John', age = 30"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">WHERE условие</label>
                            <textarea class="form-control" id="updateWhere" rows="3" placeholder="id = 1"></textarea>
                        </div>
                    </div>

                    <!-- DELETE поля -->
                    <div id="deleteFields" class="query-fields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">WHERE условие</label>
                            <textarea class="form-control" id="deleteWhere" rows="3" placeholder="id > 100"></textarea>
                        </div>
                    </div>

                    <div class="mb-3">
                        <button type="button" class="btn btn-primary" id="buildQueryBtn">
                            <i class="fas fa-hammer me-1"></i>Построить запрос
                        </button>
                        <button type="button" class="btn btn-success" id="executeQueryBtn">
                            <i class="fas fa-play me-1"></i>Выполнить
                        </button>
                        <button type="button" class="btn btn-info" id="exportQueryBtn">
                            <i class="fas fa-download me-1"></i>Экспорт
                        </button>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Сгенерированный SQL запрос</label>
                        <textarea class="form-control font-monospace" id="generatedQuery" rows="6" readonly></textarea>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Результаты выполнения -->
<div id="queryResults" class="row" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-table me-2"></i>Результаты запроса</h5>
                <div>
                    <span id="resultCount" class="badge bg-primary"></span>
                    <button class="btn btn-sm btn-outline-secondary ms-2" id="clearResultsBtn">
                        <i class="fas fa-times"></i> Очистить
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="resultsTable">
                        <thead id="resultsHead"></thead>
                        <tbody id="resultsBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно экспорта -->
<div class="modal fade" id="exportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Экспорт результатов</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm">
                    <div class="mb-3">
                        <label class="form-label">Формат экспорта</label>
                        <select class="form-select" name="format">
                            <option value="excel">Excel (.xlsx)</option>
                            <option value="json">JSON (.json)</option>
                            <option value="csv">CSV (.csv)</option>
                        </select>
                    </div>
                    <input type="hidden" name="query" id="exportQuery">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="submit" form="exportForm" class="btn btn-primary">
                    <i class="fas fa-download me-1"></i>Экспортировать
                </button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const queryType = document.getElementById('queryType');
    const tableSelect = document.getElementById('tableSelect');
    const buildQueryBtn = document.getElementById('buildQueryBtn');
    const executeQueryBtn = document.getElementById('executeQueryBtn');
    const exportQueryBtn = document.getElementById('exportQueryBtn');
    const getColumnsBtn = document.getElementById('getColumnsBtn');
    const generatedQuery = document.getElementById('generatedQuery');
    const queryResults = document.getElementById('queryResults');
    const exportModal = new bootstrap.Modal(document.getElementById('exportModal'));
    const exportForm = document.getElementById('exportForm');

    // Переключение полей в зависимости от типа запроса
    queryType.addEventListener('change', function() {
        document.querySelectorAll('.query-fields').forEach(field => {
            field.style.display = 'none';
        });
        
        const fieldsMap = {
            'SELECT': 'selectFields',
            'INSERT': 'insertFields',
            'UPDATE': 'updateFields',
            'DELETE': 'deleteFields'
        };
        
        const targetFields = document.getElementById(fieldsMap[this.value]);
        if (targetFields) {
            targetFields.style.display = 'block';
        }
    });

    // Получение полей таблицы
    getColumnsBtn.addEventListener('click', async function() {
        const table = tableSelect.value;
        if (!table) {
            alert('Выберите таблицу');
            return;
        }

        try {
            const response = await fetch(`/table/${table}/columns`);
            const columns = await response.json();
            
            if (Array.isArray(columns) && columns.length > 0) {
                const columnNames = columns.map(col => col.name || col.column_name);
                document.getElementById('selectColumns').value = columnNames.join(', ');
            } else {
                alert('Не удалось получить поля таблицы');
            }
        } catch (error) {
            console.error('Ошибка получения полей:', error);
            alert('Ошибка получения полей таблицы');
        }
    });

    // Построение запроса
    buildQueryBtn.addEventListener('click', function() {
        const type = queryType.value;
        const table = tableSelect.value;
        
        if (!table) {
            alert('Выберите таблицу');
            return;
        }

        let query = '';
        
        switch(type) {
            case 'SELECT':
                const columns = document.getElementById('selectColumns').value || '*';
                const where = document.getElementById('whereCondition').value;
                const orderBy = document.getElementById('orderBy').value;
                const limit = document.getElementById('limit').value;
                
                query = `SELECT ${columns} FROM ${table}`;
                
                if (where) query += ` WHERE ${where}`;
                if (orderBy) query += ` ORDER BY ${orderBy}`;
                if (limit) query += ` LIMIT ${limit}`;
                break;
                
            case 'INSERT':
                const insertValues = document.getElementById('insertValues').value;
                if (!insertValues) {
                    alert('Заполните значения для вставки');
                    return;
                }
                query = `INSERT INTO ${table} ${insertValues}`;
                break;
                
            case 'UPDATE':
                const setExpr = document.getElementById('setExpressions').value;
                const updateWhere = document.getElementById('updateWhere').value;
                
                if (!setExpr) {
                    alert('Заполните SET выражения');
                    return;
                }
                
                query = `UPDATE ${table} SET ${setExpr}`;
                if (updateWhere) query += ` WHERE ${updateWhere}`;
                break;
                
            case 'DELETE':
                const deleteWhere = document.getElementById('deleteWhere').value;
                
                if (!deleteWhere) {
                    alert('Заполните WHERE условие для DELETE');
                    return;
                }
                
                query = `DELETE FROM ${table} WHERE ${deleteWhere}`;
                break;
        }
        
        generatedQuery.value = query;
    });

    // Выполнение запроса
    executeQueryBtn.addEventListener('click', async function() {
        const query = generatedQuery.value;
        
        if (!query) {
            alert('Сначала постройте запрос');
            return;
        }

        try {
            const response = await fetch('/execute-sql', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ query: query })
            });
            
            const result = await response.json();
            
            if (result.success) {
                displayResults(result.data);
                document.getElementById('resultCount').textContent = `${result.data.length} записей`;
            } else {
                alert(`Ошибка выполнения запроса: ${result.error}`);
            }
        } catch (error) {
            console.error('Ошибка выполнения запроса:', error);
            alert('Ошибка выполнения запроса');
        }
    });

    // Отображение результатов
    function displayResults(data) {
        if (!data || data.length === 0) {
            queryResults.style.display = 'none';
            return;
        }

        const thead = document.getElementById('resultsHead');
        const tbody = document.getElementById('resultsBody');
        
        // Очистка предыдущих результатов
        thead.innerHTML = '';
        tbody.innerHTML = '';
        
        // Заголовки таблицы
        const headers = Object.keys(data[0]);
        const headerRow = document.createElement('tr');
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        
        // Данные таблицы
        data.forEach(row => {
            const tr = document.createElement('tr');
            headers.forEach(header => {
                const td = document.createElement('td');
                td.textContent = row[header] !== null ? row[header] : '';
                tr.appendChild(td);
            });
            tbody.appendChild(tr);
        });
        
        queryResults.style.display = 'block';
    }

    // Экспорт
    exportQueryBtn.addEventListener('click', function() {
        const query = generatedQuery.value;
        if (!query) {
            alert('Сначала постройте и выполните запрос');
            return;
        }
        
        document.getElementById('exportQuery').value = query;
        exportModal.show();
    });

    // Очистка результатов
    document.getElementById('clearResultsBtn').addEventListener('click', function() {
        queryResults.style.display = 'none';
        document.getElementById('resultsHead').innerHTML = '';
        document.getElementById('resultsBody').innerHTML = '';
    });

    // Отправка формы экспорта
    exportForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/export-sql-results', {
                method: 'POST',
                body: formData
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = response.headers.get('Content-Disposition')?.split('filename=')[1] || 'export';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                exportModal.hide();
            } else {
                alert('Ошибка экспорта');
            }
        } catch (error) {
            console.error('Ошибка экспорта:', error);
            alert('Ошибка экспорта');
        }
    });
});
</script>
{% endblock %}
